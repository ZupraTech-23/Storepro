<% layout('/layouts/boilerplate') -%>
    <link rel="stylesheet" href="/style/bill-show.css">



<div class="top no-print">

  <!-- PAYMENTS (always visible) -->
 <% if (bill.status === 'CANCELLED') { %>
  <div class="cancel-banner">
    ‚ùå THIS BILL HAS BEEN CANCELLED ‚Äî DO NOT USE
  </div>
 <%  }%>
 
   
<% if (bill.status !== 'CANCELLED') { %>
     <a href="/bills/<%= bill.id %>/payments">
    <button>Payments</button>
  </a>
    <a href="/bills/<%= bill.id %>/edit">
      <button>Edit</button>
    </a>
  
  <form method="POST" action="/bills/<%= bill.id %>/cancel">
    <button type="submit">Cancel Bill</button>
  </form>
  <button onclick="window.print()">üñ® Print Invoice</button>

    <% } %>


  <!-- EDIT & CANCEL (only if unpaid & active) -->
 
  <!-- PRINT -->

</div>


    <body class="show-bill">
        
        <% const totalGST=Number(bill.gst_percent || 0); const halfGST=totalGST / 2; %>
            <% const hasMarginScheme=items.some(i=> i.gst_method === 'margin');
                %>




                <div class="invoice-print">
                                               <h2 style="text-align: center;">
  <%= bill.status === 'CANCELLED' ? 'CANCELLED INVOICE' : bill.bill_type.replace('_', ' ') %>
</h2>
                                                <% if (bill.status === 'CANCELLED') { %>
  <div class="invoice-watermark">CANCELLED</div>
<% } %>

                    <!-- ================= FIXED HEADER (REPEATS ON EVERY PAGE) ================= -->
                    <div class="invoice-header" style="border: 1px solid black; padding: 4px;">
                        

                        <!-- LEFT : SELLER -->
                        <div class="header-left">
                            <h1>
                                <%= seller.company_name %>
                            </h1>
                            <p>
                                <%= seller.address %>
                            </p>
                            <p>Ph: <%= seller.phone %>
                            </p>
                            <p class="email"> Email: <%= seller.email %>
                            </p>
                            <% if (seller.gstin) { %>
                                <p><strong>GSTIN:</strong>
                                    <%= seller.gstin %>
                                </p>
                                <% } %>
                        </div>

                        <!-- CENTER : TITLE -->
                        <div class="header-center">
 

                        </div>

                        <!-- RIGHT : INVOICE META -->
                        <div class="header-right">
                            <p><strong>Invoice No:</strong>
                                <%= bill.invoice_no %>
                            </p>
                            <p><strong>Date:</strong>
                                <%= new Date(bill.created_at).toDateString() %>
                            </p>
                        </div>

                    </div>

                    <!-- ================= CUSTOMER DETAILS (PRINT ONCE) ================= -->
                    <div class="customer-box">
                        <table class="customer-table">
                            <tr>
                                <td><strong>Buyer Name</strong></td>
                                <td>: <%= bill.customer_name %>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Address</strong></td>
                                <td>: <%= bill.customer_address || "N/A" %>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Phone</strong></td>
                                <td>: <%= bill.customer_phone || "N/A" %>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>GSTIN</strong></td>
                                <td>: <%= bill.customer_gstin || "N/A" %>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- ================= ITEMS TABLE ================= -->
                    <table class="items-table">
                        <thead>
                            <tr class="repeat-line">
                                <th colspan=8">
                                    <%= seller.company_name %> ‚Äî Invoice No: <%= bill.invoice_no %>
                                </th>
                            </tr>
                            <tr>
                                <th style="width:5%">#</th>
                                <th style="width:35%">Particulars</th>
                                <th style="width:10%">HSN</th>
                                <th style="width:8%">Qty</th>
                                <th style="width:12%">Rate</th>
                                <th style="width:10%">GST %</th>
                                <th style="width:20%">Amount</th </tr>
                        </thead>
                        <tbody>
                            <% items.forEach((item, index)=> { %>
                                <tr>
                                    <td>
                                        <%= index + 1 %>
                                    </td>
                                    <td class="left">
                                        <%= item.product_name %>
                                    </td>
                                    <td>
                                        <%= item.hsn %>
                                    </td>
                                    <td>
                                        <%= item.quantity %>
                                    </td>
                                    <td>‚Çπ <%= Number(item.price).toFixed(2) %>
                                    </td>
                                    <td>
                                        <%= item.gst_method==='margin' ? 'Margin' : item.gst_percent %>
                                    </td>

                                    <td>‚Çπ <%= Number(item.total).toFixed(2) %>
                                    </td>
                                </tr>
                                <% }) %>
                        </tbody>
                    </table>

                    <!-- ================= TOTALS ================= -->
                    <div class="totals-section">

                        <table class="totals-table">
                            <tr>
                                <td>Subtotal</td>
                                <td>‚Çπ <%= Number(bill.subtotal).toFixed(2) %>
                                </td>
                            </tr>
                            <tr>
                                <td>CGST @ <%= halfGST %>%</td>
                                <td>‚Çπ <%= Number(bill.cgst).toFixed(2) %>
                                </td>
                            </tr>
                            <tr>
                                <td>SGST @ <%= halfGST %>%</td>
                                <td>‚Çπ <%= Number(bill.sgst).toFixed(2) %>
                                </td>
                            </tr>
                            <tr class="grand-total">
                                <td>Grand Total</td>
                                <td>‚Çπ <%= Number(bill.grand_total).toFixed(2) %>
                                </td>
                            </tr>
                        </table>

                    </div>
                    <% if (hasMarginScheme) { %>
                        <div class="invoice-note margin-note">
                            <strong>Note:</strong>
                            GST charged under <strong>Margin Scheme</strong> as per
                            Rule 32(5) of the CGST Rules, 2017.
                        </div>
                        <% } %>

                            <div class="invoice-note">
                                This is a computer generated invoice and does not require a physical signature.
                            </div>

                            <!-- ================= FOOTER ================= -->








                </div>


    </body>
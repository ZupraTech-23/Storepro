<% layout('/layouts/boilerplate') -%>

<link rel="stylesheet" href="/style/payment.css">

<div class="billing payments-page">

  <!-- HEADER -->
  <div class="billing-header">
    <h1>
      Payments
    
         Bill <%= bill.invoice_no %>
     
    </h1>

    <a href="/bills/<%= bill.id %>"  style="color: white; font-size: medium; font-weight: 500; background-color: black; padding: 4px; border: 0px; border-radius: 6px;" >View Invoice</a>
    
  </div>
  

  <div class="payment-box">

    <!-- SUMMARY (WORKS FOR BILL & CUSTOMER) -->
    <div class="payment-summary">

  <% if (bill) { %>
    <div class="item">
      <span>Total</span>
      <span class="amount">₹<%= bill.grand_total %></span>
    </div>
  <% } else { %>
    <div class="item">
      <span>Total</span>
      <span class="amount">₹<%= total %></span>
    </div>
  <% } %>

  <div class="item">
    <span>Paid</span>
    <span class="amount">₹<%= paidAmount %></span>
  </div>

  <div class="item balance">
    <span>Balance</span>
    <span class="amount" style="color:red;">
      ₹<%= balance %>
    </span>
  </div>

</div>

    <!-- PAYMENT HISTORY -->
    <table class="payment-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Time</th>
          <th>Mode</th>
          <th>Amount</th>
          <th>Reference</th>
          <th>Action</th>
        </tr>
      </thead>

      <tbody>
        <% if (!payments.length) { %>
          <tr>
            <td colspan="6" style="text-align:center;">
              No payments yet
            </td>
          </tr>
        <% } %>

        <% payments.forEach(p => { %>
          <tr>
            <td><%= new Date(p.payment_date).toLocaleDateString('en-IN', {
  day: '2-digit',
  month: 'short',
  year: 'numeric'
})
%></td>

            <td>
              <%= new Date(p.created_at).toLocaleTimeString('en-IN', {
                hour: '2-digit',
                minute: '2-digit'
              }) %>
            </td>

            <td><%= p.mode %></td>
            <td>₹<%= p.amount %></td>
            <td><%= p.reference_no || "-" %></td>

            <% if (bill && bill.status !== 'CANCELLED') { %>
              <td>
                <form
                  method="POST"
                  action="/bills/<%= bill.id %>/payments/<%= p.id %>/delete"
                  onsubmit="return confirm('Delete this payment?')"
                >
                  <input type="hidden" name="returnTo" value="<%= typeof returnTo !== 'undefined' && returnTo ? returnTo : '' %>">
                  <button class="btn-danger">Delete</button>
                </form>
              </td>
            <% } else { %>
              <td>-</td>
            <% } %>
          </tr>
        <% }) %>
      </tbody>
    </table>

    <!-- ADD PAYMENT -->
    <form
      class="payment-form"
      method="POST"
      action="<%= bill
        ? `/bills/${bill.id}/payments`
        : `/customers/${customer.id}/payments` %>"
      autocomplete="off"
    >
      <input type="hidden" name="returnTo" value="<%= typeof returnTo !== 'undefined' && returnTo ? returnTo : '' %>">

      <div class="row">
        <input
          type="number"
          name="amount"
          value="<%= bill ? balance : customer.balance %>"
          required
        >
        <small class="text-muted">
  Auto-filled with remaining balance. You can edit for partial payment.
</small>

        <select name="mode" required>
          <option value="CASH">Cash</option>
          <option value="UPI">UPI</option>
          <option value="BANK">Bank</option>
          <option value="CARD">Card</option>
        </select>
      </div>

      <div class="row">
        <input type="date" name="payment_date" required>
        <input type="text" name="reference_no" placeholder="Reference (optional)">
      </div>

      <div class="row">
        <textarea name="notes" placeholder="Notes (optional)"></textarea>
      </div>

      <button type="submit" class="create" id="paymentSubmitBtn">Save Payment</button>
    </form>

  </div>
</div>

<script>
  document.querySelector('.payment-form').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('paymentSubmitBtn');
    if (submitBtn.disabled) {
      e.preventDefault();
      return false;
    }
    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';
  });

  // Keyboard navigation for form fields
  document.addEventListener("keydown", function(e) {
    const form = document.querySelector('.payment-form');
    if (!form || !form.contains(document.activeElement)) return;

    // Only handle Enter key
    if (e.key === 'Enter') {
      e.preventDefault();
      
      const allInputs = Array.from(form.querySelectorAll('input, select, button, textarea')).filter(el => {
        return el.offsetParent !== null && el.type !== 'hidden';
      });

      const currentIndex = allInputs.indexOf(document.activeElement);
      
      // Move to next field
      if (currentIndex < allInputs.length - 1) {
        allInputs[currentIndex + 1].focus();
      }
    }
  });
</script>

<% layout('/layouts/boilerplate') -%>
  <link rel="stylesheet" href="/style/bill-new.css">


<body class="billing">

<h2>Create Bill</h2>

<form method="POST" action="/bills/create" class="bill-form">

    <!-- Bill Type -->
    <label>Bill Type</label>
    <select name="bill_type" id="bill_type" required>
        <option value="TAX_INVOICE">Tax Invoice</option>
        <option value="BILL_OF_SUPPLY">Bill of Supply</option>
        <option value="MEMORANDUM">Memorandum</option>
    </select>

    

    <hr>

    <!-- Customer Details -->
    <h3>Customer Details</h3>
    <input type="text" name="customer_name" placeholder="Customer Name" required>
    <input type="text" name="customer_phone" placeholder="Phone">

    <input type="text" 
        name="customer_address" 
        placeholder="Customer Address"
        
        
    
    >

    <input type="text" name="customer_gstin" placeholder="GSTIN (optional)">

    <hr>

    <!-- Items -->
    <h3>Items</h3>

    <table id="itemsTable">
        <thead>
            <tr>
                <th>Product</th>
                <th>Qty</th>
                <th>Price</th>
                <th class="gst-col">GST %</th>
                <th class="gst-method-col">GST Method</th>
                <th>Total</th>
                <th>Action</th>
            </tr>
        </thead>

        <tbody>
            <tr>
                <td>
                    <select name="items[0][product_id]" required>
                        <option value="">Select Product</option>
                        <% items.forEach(item => { %>
                            <option
                        value="<%= item.id %>"
                        data-price="<%= item.selling_price %>"
                        data-purchase_price="<%= item.purchase_price %>"
                        data-stock="<%= item.stock %>"
                        data-condition="<%= item.item_condition %>">
                        <%= item.name %> (Stock: <%= item.stock %>)
                        </option>
                        <% }) %>
                    </select>
                </td>

                <td>
                    <input type="number" name="items[0][quantity]" min="1" value="1">
                </td>

                <td>
                    <input type="number" name="items[0][price]" step="0.01">
                </td>

                <td class="gst-col">
                    <input type="number" name="items[0][gst_percent]" value="18">
                </td>
                <td class="gst-method-cell">
                    <select name="items[0][gst_method]" class="gst-method">
                    <option value="normal">Normal GST</option>
                    <option value="margin">Margin Scheme</option>
                    </select>
                </td>


                <td>
                    <input type="text" name="items[0][total]" readonly>
                </td>

                <td>
                    <button type="button" onclick="removeRow(this)">❌</button>
                </td>
            </tr>
        </tbody>
    </table>

    <button type="button" class="add-btn" onclick="addRow()">+ Add Item</button>

    <hr>

    <!-- Tax Summary (INSIDE FORM – IMPORTANT) -->
    <h3>Tax Summary</h3>
    <div class="tax-summary">
        <input type="text" id="subtotal" name="subtotal" placeholder="Subtotal" readonly>
        <div class="gst-breakup">
             <input type="text" id="cgst" name="cgst" placeholder="CGST" readonly>
        <input type="text" id="sgst" name="sgst" placeholder="SGST" readonly>
        </div>
       
        <input type="text" id="grandTotal" name="grand_total" placeholder="Grand Total" readonly>
    </div>
    <input type="hidden" id="billGstPercent" name="gst_percent">

    <hr>

    <button type="submit">Save Bill</button>

</form>

<script>
let rowIndex = 1;

function addRow() {
    const tbody = document.querySelector("#itemsTable tbody");
    const firstRow = tbody.rows[0];
    const newRow = firstRow.cloneNode(true);

    newRow.querySelectorAll("input, select").forEach(el => {
        el.name = el.name.replace(/\[\d+\]/, `[${rowIndex}]`);
        if (el.tagName === "INPUT") el.value = "";
    });

    tbody.appendChild(newRow);
    // ensure new row UI follows current bill type
    if (typeof handleBillTypeUI === 'function') handleBillTypeUI();
    rowIndex++;
}


function removeRow(btn) {
    const tbody = document.querySelector("#itemsTable tbody");
    if (tbody.rows.length > 1) {
        btn.closest("tr").remove();
    }
}

document.querySelectorAll("select[name*='[product_id]']").forEach(select => {
    if (select.value) {
        select.dispatchEvent(new Event('change'));
    }
});



</script>

<script src="/js/bills-new.js"></script>

</body>

<% layout('/layouts/boilerplate') -%>
  <link rel="stylesheet" href="/style/bill-new.css">


<body class="billing">

<h2>Create Bill</h2>

<form method="POST" action="/bills/create" class="bill-form" autocomplete="off">

    <!-- Bill Type -->
    <label>Bill Type</label>
    <select name="bill_type" id="bill_type" required>
        <option value="TAX_INVOICE">Tax Invoice</option>
        <option value="BILL_OF_SUPPLY">Bill of Supply</option>
        <option value="MEMORANDUM">Cash Memo</option>
    </select>

    

    <hr>

    <!-- Customer Details -->
    <h3>Customer Details</h3>
    <input type="text"
       id="customer_name"
       name="customer_name"
       placeholder="Customer Name"
       required>

<input type="text"
       id="customer_phone"
       name="customer_phone"
       placeholder="Phone (recommended)">
<small id="customerHint" class="text-success d-none d-block mt-1">
  ✔ Existing customer found — details auto-filled
</small>

<small class="text-muted d-block">
  Tip: Enter phone number to auto-fill existing customer details
</small>
<small class="text-muted d-block">
  Tip: Use the same phone number for repeat customers to keep their history together.
</small>



<input type="text"
       id="customer_address"
       name="customer_address"
       placeholder="Customer Address">

<input type="text"
       id="customer_gstin"
       name="customer_gstin"
       placeholder="GSTIN (optional)">



    <hr>

    <!-- Items -->
    <h3>Items</h3>

    <table id="itemsTable">
        <thead>
            <tr>
                <th>Product</th>
                <th>Qty</th>
                <th>Price</th>
                <th class="gst-col" >GST %</th>
                <th class="gst-method-col" style="width: 15%;">GST Method</th>
                <th>Total</th>
                <th>Action</th>
            </tr>
        </thead>

        <tbody>
            <tr>
                <td>
  <div class="form-row position-relative" style="margin: 0 !important;">
  

  <input type="text"
    class="form-control auto-input"
    name="items[0][product_name]"
    autocomplete="off"
    required
  />

  <input type="hidden" name="items[0][product_id]">
  <input type="hidden" name="items[0][purchase_price]">
  <input type="hidden" name="items[0][stock]">
  <input type="hidden" name="items[0][condition]">

  <ul class="list-group suggestion-box d-none"></ul>
</div>

</td>


                <td>
                    <input type="number" name="items[0][quantity]" min="1" value="1">
                </td>

                <td>
                    <input type="number" name="items[0][price]" step="0.01">
                </td>

                <td class="gst-col">
                    <input type="number" name="items[0][gst_percent]" value="18">
                </td>
                <td class="gst-method-cell">
                    <select name="items[0][gst_method]" class="gst-method">
                    <option value="normal">Normal GST</option>
                    <option value="margin">Margin Scheme</option>
                    </select>
                </td>


                <td>
                    <input type="text" name="items[0][total]" readonly>
                </td>

                <td>
                    <button type="button" onclick="removeRow(this)">❌</button>
                </td>
            </tr>
        </tbody>
    </table>

    <button type="button" class="add-btn" onclick="addRow()">+ Add Item</button>

    <hr>

    <!-- Tax Summary (INSIDE FORM – IMPORTANT) -->
    <h3>Tax Summary</h3>
    <div class="tax-summary">
        <input type="text" id="subtotal" name="subtotal" placeholder="Subtotal" readonly>
        <div class="gst-breakup">
             <input type="text" id="cgst" name="cgst" placeholder="CGST" readonly>
        <input type="text" id="sgst" name="sgst" placeholder="SGST" readonly>
        </div>
       
        <input type="text" id="grandTotal" name="grand_total" placeholder="Grand Total" readonly>
    </div>
    <input type="hidden" id="billGstPercent" name="gst_percent">

    <hr>

    <button type="submit" id="saveBtn">Save Bill</button>

</form>

<script>
let rowIndex = 1;

function addRow() {
    const tbody = document.querySelector("#itemsTable tbody");
    const firstRow = tbody.rows[0];
    const newRow = firstRow.cloneNode(true);

    newRow.querySelectorAll("input, select").forEach(el => {
        el.name = el.name.replace(/\[\d+\]/, `[${rowIndex}]`);
        if (el.tagName === "INPUT") el.value = "";
    });

    tbody.appendChild(newRow);
    // ensure new row UI follows current bill type
    if (typeof handleBillTypeUI === 'function') handleBillTypeUI();
    rowIndex++;
}


function removeRow(btn) {
    const tbody = document.querySelector("#itemsTable tbody");
    if (tbody.rows.length > 1) {
        btn.closest("tr").remove();
    }
}

document.querySelectorAll("select[name*='[product_id]']").forEach(select => {
    if (select.value) {
        select.dispatchEvent(new Event('change'));
    }
});


document.addEventListener("DOMContentLoaded", () => {

  const products = JSON.parse(
    document.getElementById("products-data").textContent
  );

  document.addEventListener("input", function (e) {
    if (!e.target.classList.contains("auto-input")) return;

    const input = e.target;
    const formRow = input.closest(".form-row");
    const box = formRow.querySelector(".suggestion-box");
    const query = input.value.toLowerCase();

    box.innerHTML = "";

    if (!query) {
      box.classList.add("d-none");
      return;
    }

    const matches = products.filter(p =>
      p.name.toLowerCase().includes(query)
    );

    matches.forEach(p => {
      const li = document.createElement("li");
      li.className = "list-group-item list-group-item-action";
      li.textContent = `${p.name} (Stock: ${p.stock})`;

      li.addEventListener("click", () => {
        input.value = p.name;

        const row = formRow.closest("tr");

        formRow.querySelector('[name$="[product_id]"]').value = p.id;
        formRow.querySelector('[name$="[purchase_price]"]').value = p.purchase_price;
        formRow.querySelector('[name$="[stock]"]').value = p.stock;
        formRow.querySelector('[name$="[condition]"]').value = p.item_condition;

        // Set visible price field in table row
        row.querySelector('input[name*="[price]"]').value = p.selling_price;

        // Set quantity to 1 and trigger calculations
        const qtyInput = row.querySelector('input[name*="[quantity]"]');
        qtyInput.value = 1;

        box.classList.add("d-none");

        // Dispatch change event to trigger calculations
        const productIdInput = formRow.querySelector('[name$="[product_id]"]');
        productIdInput.dispatchEvent(new Event('change', { bubbles: true }));
      });

      box.appendChild(li);
    });

    box.classList.toggle("d-none", matches.length === 0);
  });

  // Hide suggestions when clicking outside
  document.addEventListener("click", (e) => {
    if (!e.target.closest(".form-row")) {
      document.querySelectorAll(".suggestion-box")
        .forEach(box => box.classList.add("d-none"));
    }
  });

});
document.getElementById("saveBtn").addEventListener("click", function (e) {
  // prevent multiple clicks
  if (this.disabled) {
    e.preventDefault();
    return;
  }

  this.disabled = true;
  this.innerText = "Saving...";
  
  // Submit the form
  this.closest('form').submit();
});

// Keyboard navigation for form fields
document.addEventListener("keydown", function(e) {
  const form = document.querySelector('.bill-form');
  if (!form || !form.contains(document.activeElement)) return;

  // Only handle Enter key
  if (e.key === 'Enter') {
    e.preventDefault();
    
    const allInputs = Array.from(form.querySelectorAll('input, select, button, textarea')).filter(el => {
      return el.offsetParent !== null && el.type !== 'hidden';
    });

    const currentIndex = allInputs.indexOf(document.activeElement);
    
    // Move to next field
    const currentRow = document.activeElement.closest('tr');
    if (currentRow) {
      const nextRow = currentRow.nextElementSibling;
      if (nextRow) {
        const cellIndex = Array.from(currentRow.cells).indexOf(document.activeElement.closest('td'));
        const input = nextRow.cells[cellIndex]?.querySelector('input, select');
        if (input) input.focus();
      }
    } else {
      // Not in a table, just move to next input
      if (currentIndex < allInputs.length - 1) {
        allInputs[currentIndex + 1].focus();
      }
    }
  }
});



</script>

<script src="/js/bills-new.js"></script>


<script type="application/json" id="products-data">
<%- JSON.stringify(products) %>
</script>


</body>
